<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Celebrity Barber</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='profile.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="profile-container">
        <!-- Close Button -->
        <button class="close-btn" onclick="window.location.href='/clientdashboard'">‚úï</button>
        
        <!-- Profile Header -->
        <h1 class="page-title">MY PROFILE</h1>
        <hr class="header-separator">
        
        <!-- Profile Picture Section -->
        <div class="profile-picture-section">
            <div class="current-avatar" id="currentAvatar">
                <img id="avatarImage" src="" alt="Profile Photo" style="display: none;">
                <span id="avatarEmoji" class="avatar-emoji">üë§</span>
                <div class="avatar-overlay" onclick="document.getElementById('photoInput').click()">
                    <span>üì∑</span>
                </div>
            </div>
            <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
            
            <div class="profile-actions">
                <button class="action-btn change-btn" onclick="document.getElementById('photoInput').click()">
                    <span>üì∑</span> Change Photo
                </button>
                <button class="action-btn delete-btn" onclick="deletePhoto()">
                    <span>üóëÔ∏è</span> Delete
                </button>
            </div>
        </div>
        
        <!-- Preview Modal -->
        <div class="preview-modal" id="previewModal" style="display: none;">
            <div class="preview-content">
                <span class="preview-title">Preview New Photo</span>
                <img id="previewImage" src="" alt="Preview">
                <div class="preview-actions">
                    <button class="btn-cancel" onclick="cancelUpload()">Cancel</button>
                    <button class="btn-save" onclick="savePhoto()">Save Photo</button>
                </div>
            </div>
        </div>
        
        <!-- User Info Form -->
        <form class="profile-form" onsubmit="updateProfile(event)">
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="fullName" value="{{ user.full_name if user else 'User' }}">
            </div>
            
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="email" value="{{ user.email if user else 'user@example.com' }}" disabled>
            </div>
            
            <div class="form-group">
                <label>Phone Number</label>
                <input type="tel" id="phone" placeholder="Enter phone number" value="{{ user.phone if user else '' }}">
            </div>
            
            <div class="form-group">
                <label>Address</label>
                <input type="text" id="address" placeholder="Enter address" value="{{ user.address if user else '' }}">
            </div>
            
            <button type="submit" class="save-btn">Save Changes</button>
        </form>
        
        <!-- Success Message -->
        <div class="success-toast" id="successToast">
            <span>‚úì</span> Profile updated successfully!
        </div>
    </div>
    
        <script>
        let currentPhoto = null;
        let pendingPhoto = null;

        window.addEventListener('DOMContentLoaded', async function() {
            await loadProfileFromServer();
        });

        async function loadProfileFromServer() {
            try {
                const response = await fetch('/api/user/profile');
                const result = await response.json();

                if (result.success && result.data) {
                    const data = result.data;
                    const fullName = document.getElementById('fullName');
                    const phone = document.getElementById('phone');
                    const address = document.getElementById('address');

                    if (fullName && data.full_name) fullName.value = data.full_name;
                    if (phone) phone.value = data.phone || '';
                    if (address) address.value = data.address || '';

                    currentPhoto =
                        data.photo_url ||
                        data.profile_photo ||
                        data.profilePhoto ||
                        data.photo ||
                        data.avatar ||
                        null;

                    if (currentPhoto) {
                        sessionStorage.setItem('profilePhoto', currentPhoto);
                    } else {
                        sessionStorage.removeItem('profilePhoto');
                    }

                    updateAvatarDisplay();
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                const fallback = sessionStorage.getItem('profilePhoto');
                currentPhoto = fallback || null;
                updateAvatarDisplay();
            }
        }

        function updateAvatarDisplay() {
            const avatarImage = document.getElementById('avatarImage');
            const avatarEmoji = document.getElementById('avatarEmoji');

            if (!avatarImage || !avatarEmoji) return;

            if (currentPhoto) {
                avatarImage.src = currentPhoto;
                avatarImage.style.display = 'block';
                avatarEmoji.style.display = 'none';
            } else {
                avatarImage.style.display = 'none';
                avatarEmoji.style.display = 'flex';
            }
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                alert('Image must be less than 5MB');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                pendingPhoto = e.target.result;
                showPreview(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        function showPreview(photoData) {
            const modal = document.getElementById('previewModal');
            const previewImage = document.getElementById('previewImage');
            previewImage.src = photoData;
            modal.style.display = 'flex';
        }

        function cancelUpload() {
            document.getElementById('previewModal').style.display = 'none';
            document.getElementById('photoInput').value = '';
            pendingPhoto = null;
        }

        async function savePhoto() {
            if (!pendingPhoto) return;

            const success = await persistProfile({ photo_url: pendingPhoto });
            if (!success) return;

            currentPhoto = pendingPhoto;
            sessionStorage.setItem('profilePhoto', currentPhoto);
            updateAvatarDisplay();

            document.getElementById('previewModal').style.display = 'none';
            document.getElementById('photoInput').value = '';
            pendingPhoto = null;

            showSuccessToast('Profile photo updated!');
        }

        async function deletePhoto() {
            if (!currentPhoto) {
                alert('No photo to delete');
                return;
            }

            if (!confirm('Are you sure you want to delete your profile photo?')) {
                return;
            }

            const success = await persistProfile({ photo_url: '' });
            if (!success) return;

            currentPhoto = null;
            sessionStorage.removeItem('profilePhoto');
            updateAvatarDisplay();
            showSuccessToast('Profile photo deleted');
        }

        async function updateProfile(event) {
            event.preventDefault();

            const fullName = document.getElementById('fullName').value;
            const phone = document.getElementById('phone').value;
            const address = document.getElementById('address').value;

            const success = await persistProfile({
                full_name: fullName,
                phone: phone,
                address: address
            });

            if (success) {
                showSuccessToast('Profile updated successfully!');
            }
        }

        async function persistProfile(payload) {
            try {
                const response = await fetch('/api/user/profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (!result.success) {
                    alert(result.message || 'Unable to save profile changes.');
                    return false;
                }

                return true;
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Error saving profile changes. Please try again.');
                return false;
            }
        }

        function showSuccessToast(message) {
            const toast = document.getElementById('successToast');
            toast.textContent = '\u2713 ' + message;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>

