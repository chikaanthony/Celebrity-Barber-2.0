<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Celebrity Barber</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='analytics.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Poppins:wght@300;400;500;600&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body {
            background: #0a0a12;
            min-height: 100vh;
            font-family: 'Poppins', sans-serif;
            color: #fff;
        }
        
        .analytics-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .analytics-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(212, 175, 55, 0.3);
        }
        
        .nav-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .back-btn {
            background: rgba(212, 175, 55, 0.2);
            color: #d4af37;
            border: 1px solid #d4af37;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: calc(14px * var(--mobile-font-scale, 1));
            transition: all 0.3s;
            text-decoration: none;
        }
        
        .back-btn:hover {
            background: #d4af37;
            color: #0a0a12;
        }
        
        .page-title {
            font-family: 'Orbitron', sans-serif;
            color: #d4af37;
            font-size: calc(20px * var(--mobile-font-scale, 1));
            margin: 0;
        }
        
        .admin-label {
            background: rgba(212, 175, 55, 0.2);
            color: #d4af37;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .metrics-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .metric-card.highlight {
            border-color: rgba(212, 175, 55, 0.5);
            background: rgba(212, 175, 55, 0.1);
        }
        
        .metric-icon {
            font-size: calc(32px * var(--mobile-font-scale, 1));
        }
        
        .metric-info {
            display: flex;
            flex-direction: column;
        }
        
        .metric-value {
            font-family: 'Orbitron', sans-serif;
            font-size: calc(24px * var(--mobile-font-scale, 1));
            color: #d4af37;
            font-weight: 700;
        }
        
        .metric-label {
            color: #888;
            font-size: calc(12px * var(--mobile-font-scale, 1));
            margin-top: 4px;
        }

        .daily-pulse-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
            gap: 14px;
        }

        .pulse-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 14px;
        }

        .pulse-label {
            display: block;
            color: #aaa;
            font-size: calc(12px * var(--mobile-font-scale, 1));
            margin-bottom: 6px;
        }

        .pulse-value {
            display: block;
            color: #d4af37;
            font-family: 'Orbitron', sans-serif;
            font-size: calc(18px * var(--mobile-font-scale, 1));
            font-weight: 700;
        }

        .pulse-note {
            margin-top: 12px;
            color: #9a9a9a;
            font-size: calc(13px * var(--mobile-font-scale, 1));
        }
        
        .section-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .section-title {
            font-family: 'Orbitron', sans-serif;
            color: #d4af37;
            font-size: calc(16px * var(--mobile-font-scale, 1));
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .daily-list, .monthly-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .daily-row, .monthly-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }
        
        .daily-date, .monthly-date {
            color: #aaa;
            font-size: calc(14px * var(--mobile-font-scale, 1));
        }
        
        .daily-transactions {
            color: #888;
            font-size: calc(13px * var(--mobile-font-scale, 1));
        }
        
        .daily-amount, .monthly-amount {
            font-family: 'Orbitron', sans-serif;
            color: #d4af37;
            font-weight: 600;
        }
        
        .monthly-row {
            position: relative;
            overflow: hidden;
        }
        
        .monthly-bar {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: rgba(212, 175, 55, 0.15);
            width: var(--width);
            z-index: 0;
        }
        
        .monthly-row > * {
            position: relative;
            z-index: 1;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        @media (max-width: 700px) {
            .analytics-container {
                padding: 12px;
            }

            .metrics-row {
                grid-template-columns: repeat(4, minmax(0, 1fr));
                gap: 8px;
                margin-bottom: 16px;
            }

            .metric-card {
                padding: 10px 6px;
                min-height: 92px;
                flex-direction: column;
                justify-content: center;
                text-align: center;
                gap: 6px;
            }

            .metric-icon {
                font-size: calc(16px * var(--mobile-font-scale, 1));
                line-height: 1;
            }

            .metric-info {
                align-items: center;
            }

            .metric-value {
                font-size: calc(13px * var(--mobile-font-scale, 1));
                line-height: 1.1;
            }

            .metric-label {
                font-size: calc(8px * var(--mobile-font-scale, 1));
                letter-spacing: 0.4px;
                line-height: 1.2;
            }
        }
    </style>
</head>
<body>
    <div class="analytics-container">
        <!-- Header -->
        <nav class="analytics-nav">
            <div class="nav-left">
                <button class="back-btn" onclick="window.location.href='/admin'">‚Üê</button>
                <h1 class="page-title">ANALYTICS DASHBOARD</h1>
            </div>
            <div class="nav-right">
                <span class="admin-label">Admin</span>
            </div>
        </nav>
        
        <!-- Core Metric Cards -->
        <div class="metrics-row">
            <div class="metric-card">
                <div class="metric-icon">üë•</div>
                <div class="metric-info">
                    <span class="metric-value" id="totalUsers">-</span>
                    <span class="metric-label">TOTAL USERS</span>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">üí∞</div>
                <div class="metric-info">
                    <span class="metric-value" id="totalRevenue">-</span>
                    <span class="metric-label">TOTAL REVENUE</span>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">üëë</div>
                <div class="metric-info">
                    <span class="metric-value" id="activeVips">-</span>
                    <span class="metric-label">ACTIVE VIPs</span>
                </div>
            </div>
            <div class="metric-card highlight">
                <div class="metric-icon">‚è∞</div>
                <div class="metric-info">
                    <span class="metric-value" id="pendingRequests">-</span>
                    <span class="metric-label">PENDING REQUESTS</span>
                </div>
            </div>
        </div>

        <div class="section-card">
            <h2 class="section-title">DAILY PULSE</h2>
            <div class="daily-pulse-grid">
                <div class="pulse-card">
                    <span class="pulse-label" id="todayLabel">Today</span>
                    <span class="pulse-value" id="todayRevenue">NGN 0</span>
                </div>
                <div class="pulse-card">
                    <span class="pulse-label" id="yesterdayLabel">Yesterday</span>
                    <span class="pulse-value" id="yesterdayRevenue">NGN 0</span>
                </div>
                <div class="pulse-card">
                    <span class="pulse-label">Change</span>
                    <span class="pulse-value" id="dailyDelta">NGN 0</span>
                </div>
            </div>
            <p class="pulse-note" id="dailyInsight">Day-over-day movement will appear here.</p>
        </div>
        
        <!-- Daily Revenue Tracker -->
        <div class="section-card">
            <h2 class="section-title">üìä RECENT TRANSACTIONS</h2>
            <div class="daily-list" id="dailyList">
                <div class="loading">Loading transactions...</div>
            </div>
        </div>
        
        <!-- Monthly Performance -->
        <div class="section-card">
            <h2 class="section-title">üìà MONTHLY SUMMARY</h2>
            <div class="monthly-list" id="monthlyList">
                <div class="loading">Loading monthly data...</div>
            </div>
        </div>
    </div>
    <script>
        // Fetch analytics data
        async function loadAnalytics() {
            try {
                const response = await fetch('/api/admin/analytics');
                const result = await response.json();

                if (result.success) {
                    const data = result.data || {};
                    document.getElementById('totalUsers').textContent = data.total_users || 0;
                    document.getElementById('totalRevenue').textContent = 'NGN ' + Number(data.total_revenue || 0).toLocaleString();
                    document.getElementById('activeVips').textContent = data.active_vips || 0;

                    const todayRevenue = Number(data.today_revenue || 0);
                    const yesterdayRevenue = Number(data.yesterday_revenue || 0);
                    const dailyDelta = Number(data.daily_revenue_delta || 0);
                    const deltaPrefix = dailyDelta >= 0 ? '+' : '-';

                    document.getElementById('todayLabel').textContent = data.today_label || 'Today';
                    document.getElementById('yesterdayLabel').textContent = data.yesterday_label || 'Yesterday';
                    document.getElementById('todayRevenue').textContent = 'NGN ' + todayRevenue.toLocaleString();
                    document.getElementById('yesterdayRevenue').textContent = 'NGN ' + yesterdayRevenue.toLocaleString();
                    document.getElementById('dailyDelta').textContent = `${deltaPrefix}NGN ${Math.abs(dailyDelta).toLocaleString()}`;

                    const deltaPct = Number(data.daily_revenue_delta_pct || 0);
                    const todayTx = Number(data.today_transactions || 0);
                    const yesterdayTx = Number(data.yesterday_transactions || 0);
                    document.getElementById('dailyInsight').textContent =
                        `${data.today_label || 'Today'} has ${todayTx} transaction${todayTx === 1 ? '' : 's'} vs ${yesterdayTx} yesterday (${deltaPct >= 0 ? '+' : ''}${deltaPct}%).`;
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        // Fetch pending approvals
        async function loadPending() {
            try {
                const response = await fetch('/api/admin/pending-approvals');
                const result = await response.json();

                if (result.success) {
                    document.getElementById('pendingRequests').textContent = result.data.length || 0;
                }
            } catch (error) {
                console.error('Error loading pending:', error);
            }
        }

        // Fetch transactions for daily list
        async function loadTransactions() {
            try {
                const response = await fetch('/api/admin/ledger');
                const result = await response.json();

                const container = document.getElementById('dailyList');

                if (result.success && result.data && result.data.length > 0) {
                    const transactions = result.data.slice(0, 10);
                    container.innerHTML = transactions.map(t => `
                        <div class="daily-row">
                            <span class="daily-date">${t.createdAtDisplay || t.createdDate || 'Date unavailable'}</span>
                            <span class="daily-transactions">${(t.type || 'transaction').toUpperCase()} - ${t.user_name || t.user_email || 'System'}</span>
                            <span class="daily-amount">NGN ${Number(t.amount || 0).toLocaleString()}</span>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="empty-state">No transactions yet</div>';
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
                document.getElementById('dailyList').innerHTML = '<div class="empty-state">Error loading transactions</div>';
            }
        }

        // Fetch monthly data
        async function loadMonthlyData() {
            try {
                const response = await fetch('/api/admin/ledger');
                const result = await response.json();

                const container = document.getElementById('monthlyList');

                if (result.success && result.data && result.data.length > 0) {
                    const monthly = {};
                    result.data.forEach(t => {
                        const rawDate = t.created_at || t.createdAt || t.created_at_iso;
                        if (!rawDate) return;

                        const date = new Date(rawDate);
                        if (Number.isNaN(date.getTime())) return;

                        const monthKey = date.toLocaleString('default', { month: 'short', year: 'numeric' });
                        if (!monthly[monthKey]) {
                            monthly[monthKey] = 0;
                        }
                        monthly[monthKey] += Number(t.amount || 0);
                    });

                    const sortedMonths = Object.entries(monthly)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 6);

                    const maxAmount = sortedMonths[0]?.[1] || 1;

                    container.innerHTML = sortedMonths.map(([month, amount]) => {
                        const width = Math.max((amount / maxAmount) * 100, 10);
                        return `
                            <div class="monthly-row">
                                <span class="monthly-date">${month}</span>
                                <span class="monthly-bar" style="--width: ${width}%"></span>
                                <span class="monthly-amount">NGN ${amount.toLocaleString()}</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<div class="empty-state">No monthly data available</div>';
                }
            } catch (error) {
                console.error('Error loading monthly data:', error);
                document.getElementById('monthlyList').innerHTML = '<div class="empty-state">Error loading data</div>';
            }
        }

        loadAnalytics();
        loadPending();
        loadTransactions();
        loadMonthlyData();

        setInterval(loadAnalytics, 60000);
        setInterval(loadPending, 30000);
        setInterval(loadTransactions, 60000);
        setInterval(loadMonthlyData, 120000);
    </script>
</body>
</html>



