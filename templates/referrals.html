<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Referral History - Celebrity Barber</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='clientdashboard.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Orbitron:wght@500;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --ref-bg: #0a0a12;
            --ref-card-bg: rgba(255, 255, 255, 0.05);
            --ref-card-border: rgba(255, 255, 255, 0.1);
            --ref-text: #ffffff;
            --ref-muted: #aaaaaa;
            --ref-soft: #666666;
            --ref-gold: #d4af37;
            --ref-btn-bg: rgba(212, 175, 55, 0.2);
            --ref-btn-text: #d4af37;
            --ref-btn-border: #d4af37;
            --ref-progress-bg: rgba(255, 255, 255, 0.1);
            --ref-progress-border: rgba(255, 255, 255, 0.2);
            --ref-progress-line: rgba(255, 255, 255, 0.2);
        }

        html[data-theme="light"] {
            --ref-bg: #f3f6fb;
            --ref-card-bg: #ffffff;
            --ref-card-border: rgba(15, 23, 42, 0.12);
            --ref-text: #0f172a;
            --ref-muted: #475569;
            --ref-soft: #64748b;
            --ref-gold: #b88915;
            --ref-btn-bg: rgba(184, 137, 21, 0.08);
            --ref-btn-text: #8a6a15;
            --ref-btn-border: rgba(184, 137, 21, 0.45);
            --ref-progress-bg: rgba(15, 23, 42, 0.06);
            --ref-progress-border: rgba(15, 23, 42, 0.16);
            --ref-progress-line: rgba(15, 23, 42, 0.16);
        }

        body {
            background: var(--ref-bg);
            min-height: 100vh;
            padding-bottom: calc(50px + env(safe-area-inset-bottom, 0px));
        }
        
        .page-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(212, 175, 55, 0.3);
        }
        
        .page-header h1 {
            font-family: 'Orbitron', sans-serif;
            color: var(--ref-gold);
            font-size: calc(24px * var(--mobile-font-scale, 1));
            margin: 0;
        }

        .back-btn {
            background: var(--ref-btn-bg);
            color: var(--ref-btn-text);
            border: 1px solid var(--ref-btn-border);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-size: calc(14px * var(--mobile-font-scale, 1));
            transition: all 0.3s;
            text-decoration: none;
        }
        
        .back-btn:hover {
            background: var(--ref-gold);
            color: #0a0a12;
        }
        
        .referral-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-box {
            background: var(--ref-card-bg);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--ref-card-border);
        }
        
        .stat-num {
            font-family: 'Orbitron', sans-serif;
            font-size: calc(36px * var(--mobile-font-scale, 1));
            color: var(--ref-gold);
            display: block;
        }

        .stat-label {
            color: var(--ref-muted);
            font-size: calc(14px * var(--mobile-font-scale, 1));
            margin-top: 5px;
        }
        
        .referral-section h2 {
            font-family: 'Orbitron', sans-serif;
            color: var(--ref-gold);
            font-size: calc(18px * var(--mobile-font-scale, 1));
            margin-bottom: 15px;
        }

        .referral-item {
            background: var(--ref-card-bg);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--ref-card-border);
            gap: 12px;
        }
        
        .referral-item:hover {
            border-color: rgba(212, 175, 55, 0.5);
        }

        .referral-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
            min-width: 0;
        }
        
        .referral-name {
            color: var(--ref-text);
            font-weight: 600;
        }

        .referral-email {
            color: var(--ref-muted);
            font-size: calc(12px * var(--mobile-font-scale, 1));
        }
        
        .reward-earned {
            color: #4caf50;
            font-size: calc(14px * var(--mobile-font-scale, 1));
        }
        
        .reward-pending {
            color: #ffc107;
            font-size: calc(14px * var(--mobile-font-scale, 1));
        }
        
        .share-code-btn {
            width: 100%;
            background: linear-gradient(135deg, #d4af37 0%, #aa8a2e 100%);
            color: #0a0a12;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: calc(16px * var(--mobile-font-scale, 1));
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            font-family: 'Poppins', sans-serif;
        }
        
        .share-code-btn:hover {
            transform: scale(1.02);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--ref-soft);
        }

        .empty-state h2 {
            font-family: 'Orbitron', sans-serif;
            color: var(--ref-gold);
            margin-bottom: 10px;
        }

        .referral-code-display {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid var(--ref-gold);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
        }
        
        .referral-code-display:hover {
            background: rgba(212, 175, 55, 0.2);
        }
        
        .referral-code-label {
            color: var(--ref-muted);
            font-size: calc(12px * var(--mobile-font-scale, 1));
            margin-bottom: 5px;
        }

        .referral-code-value {
            font-family: 'Orbitron', sans-serif;
            color: var(--ref-gold);
            font-size: calc(24px * var(--mobile-font-scale, 1));
        }
        
        /* Milestones */
        .progress-section {
            background: var(--ref-card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--ref-card-border);
        }
        
        .progress-title {
            font-family: 'Orbitron', sans-serif;
            color: var(--ref-gold);
            font-size: calc(16px * var(--mobile-font-scale, 1));
            text-align: center;
            margin-bottom: 20px;
        }
        
        .milestones {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .milestone {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }
        
        .milestone-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--ref-progress-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: calc(24px * var(--mobile-font-scale, 1));
            border: 2px solid var(--ref-progress-border);
        }

        .milestone-circle.active {
            background: rgba(212, 175, 55, 0.3);
            border-color: var(--ref-gold);
        }

        .milestone-label {
            color: var(--ref-muted);
            font-size: calc(11px * var(--mobile-font-scale, 1));
            margin-top: 8px;
            text-align: center;
        }

        .milestone-line {
            flex: 1;
            height: 2px;
            background: var(--ref-progress-line);
            margin: 0 5px;
            margin-bottom: 20px;
        }

        .progress-hint {
            text-align: center;
            color: var(--ref-muted);
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="page-header">
            <h1>üéÅ My Referrals</h1>
            <a href="/clientdashboard" class="back-btn">‚Üê Back to Dashboard</a>
        </div>
        
        <div class="referral-code-display" onclick="copyReferralCode()">
            <div class="referral-code-label">YOUR REFERRAL CODE</div>
            <div class="referral-code-value" id="referralCode">Loading...</div>
        </div>
        
        <!-- Referral Streak / Progress -->
        <div class="progress-section">
            <h2 class="progress-title">üéØ PROGRESS TOWARD FREE CUT</h2>
            <div class="milestones">
                <div class="milestone" id="milestone1">
                    <div class="milestone-circle">
                        <span class="milestone-icon">üéüÔ∏è</span>
                    </div>
                    <span class="milestone-label">30% OFF</span>
                </div>
                <div class="milestone-line"></div>
                <div class="milestone" id="milestone2">
                    <div class="milestone-circle">
                        <span class="milestone-icon">üéüÔ∏è</span>
                    </div>
                    <span class="milestone-label">60% OFF</span>
                </div>
                <div class="milestone-line"></div>
                <div class="milestone" id="milestone3">
                    <div class="milestone-circle">
                        <span class="milestone-icon">‚úÇÔ∏è</span>
                    </div>
                    <span class="milestone-label">FREE CUT</span>
                </div>
            </div>
            <p class="progress-hint">Refer friends to unlock rewards!</p>
        </div>
        
        <div class="referral-stats">
            <div class="stat-box">
                <span class="stat-num" id="totalReferrals">0</span>
                <span class="stat-label">Total Referrals</span>
            </div>
            <div class="stat-box">
                <span class="stat-num" id="rewardsEarned">0</span>
                <span class="stat-label">Rewards Earned</span>
            </div>
        </div>
        
        <div class="referral-section">
            <h2>Recent Referrals</h2>
            <div id="referral-list">
                <div class="empty-state">
                    <h2>Loading...</h2>
                    <p>Fetching your referral history</p>
                </div>
            </div>
        </div>
        
        <button class="share-code-btn" onclick="shareReferral()">üîó Share Referral Code</button>
    </div>

    <script>
        // Load user's referral data
        async function loadReferrals() {
            try {
                // Get user profile for referral code
                const profileRes = await fetch('/api/user/profile');
                const profileData = await profileRes.json();
                
                if (profileData.success && profileData.data) {
                    document.getElementById('referralCode').textContent = profileData.data.referral_code || 'N/A';
                    const referralCount = profileData.data.referral_count || 0;
                    document.getElementById('totalReferrals').textContent = referralCount;
                    
                    // Update milestone progress
                    updateMilestones(referralCount);
                }
                
                // Get user's referral history
                const historyRes = await fetch('/api/user/referrals');
                const historyData = await historyRes.json();
                
                const rewardsEarned = document.getElementById('rewardsEarned');
                const listContainer = document.getElementById('referral-list');
                
                if (historyData.success && historyData.data && historyData.data.length > 0) {
                    const referrals = historyData.data;
                    const successful = referrals.filter(r => r.status === 'successful').length;
                    rewardsEarned.textContent = successful;
                    
                    listContainer.innerHTML = referrals.map(ref => `
                        <div class="referral-item ${ref.status}">
                            <div class="referral-info">
                                <span class="referral-name">${ref.name}</span>
                                <span class="referral-email">${ref.email}</span>
                            </div>
                            <span class="reward-${ref.status}">
                                ${ref.status === 'successful' ? (ref.claimed === 'freecut' ? 'üéâ Free Cut' : 'üé´ 30% OFF') : '‚è≥ Pending'}
                            </span>
                        </div>
                    `).join('');
                } else {
                    rewardsEarned.textContent = '0';
                    listContainer.innerHTML = `
                        <div class="referral-item">
                            <span class="referral-name">No referrals yet</span>
                            <span class="reward-pending">Start sharing!</span>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error loading referrals:', error);
            }
        }
        
        function updateMilestones(count) {
            // 1 referral = 30% off, 2 = 60% off, 3+ = free cut
            const m1 = document.getElementById('milestone1');
            const m2 = document.getElementById('milestone2');
            const m3 = document.getElementById('milestone3');
            
            // Reset all
            m1.querySelector('.milestone-circle').classList.remove('active');
            m2.querySelector('.milestone-circle').classList.remove('active');
            m3.querySelector('.milestone-circle').classList.remove('active');
            
            if (count >= 1) {
                m1.querySelector('.milestone-circle').classList.add('active');
            }
            if (count >= 2) {
                m2.querySelector('.milestone-circle').classList.add('active');
            }
            if (count >= 3) {
                m3.querySelector('.milestone-circle').classList.add('active');
            }
        }
        
        function copyReferralCode() {
            const code = document.getElementById('referralCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('Referral code copied: ' + code);
            });
        }
        
        function shareReferral() {
            const code = document.getElementById('referralCode').textContent;
            const text = `Use my referral code ${code} at Celebrity Barber for exclusive discounts!`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Refer a Friend',
                    text: text
                });
            } else {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Referral text copied to clipboard!');
                });
            }
        }
        
        loadReferrals();
    </script>
</body>
</html>

