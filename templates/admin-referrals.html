<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Referral Management - Celebrity Barber</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='admin.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Orbitron:wght@500;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #d4af37;
            --gold-light: #f0d875;
            --dark: #0a0a0a;
            --dark-secondary: #111111;
            --dark-tertiary: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --success: #00cc00;
            --pending: #ff9800;
            --danger: #ff4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--dark);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: linear-gradient(90deg, var(--dark-secondary) 0%, var(--dark-tertiary) 100%);
            border-bottom: 2px solid var(--gold);
            border-radius: 16px 16px 0 0;
            margin-bottom: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn {
            color: var(--gold);
            text-decoration: none;
            font-size: calc(14px * var(--mobile-font-scale, 1));
            padding: 8px 15px;
            border: 1px solid var(--gold);
            border-radius: 8px;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: var(--gold);
            color: var(--dark);
        }

        .page-title {
            font-family: 'Orbitron', sans-serif;
            color: var(--gold);
            font-size: calc(20px * var(--mobile-font-scale, 1));
            letter-spacing: 2px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .admin-badge {
            background: var(--gold);
            color: var(--dark);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: calc(12px * var(--mobile-font-scale, 1));
            font-weight: 700;
        }

        /* Main Content */
        .main-content {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 0 0 16px 16px;
            padding: 25px;
            min-height: calc(100vh - 120px);
        }

        /* Stats Cards */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--dark-secondary);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-card.highlight {
            border-color: var(--gold);
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, var(--dark-secondary) 100%);
        }

        .stat-icon {
            font-size: calc(32px * var(--mobile-font-scale, 1));
            margin-bottom: 10px;
        }

        .stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: calc(28px * var(--mobile-font-scale, 1));
            color: var(--gold);
            font-weight: 700;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: calc(13px * var(--mobile-font-scale, 1));
            margin-top: 5px;
        }

        /* Pending Claims Alert */
        .pending-alert {
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.2) 0%, rgba(212, 175, 55, 0.05) 100%);
            border: 1px solid var(--gold);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .pending-alert-text {
            color: var(--gold);
            font-weight: 600;
        }

        .pending-count {
            background: var(--gold);
            color: var(--dark);
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 700;
            animation: pulse-gold 2s infinite;
        }

        @keyframes pulse-gold {
            0%, 100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(212, 175, 55, 0); }
        }

        /* Referral Activity Stack */
        .activity-section {
            margin-top: 20px;
        }

        .section-title {
            font-family: 'Orbitron', sans-serif;
            color: var(--text-primary);
            font-size: calc(16px * var(--mobile-font-scale, 1));
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .referral-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .referral-row {
            display: grid;
            grid-template-columns: 120px 1fr 1fr 120px 150px 50px;
            align-items: center;
            background: var(--dark-secondary);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px 20px;
            transition: all 0.3s;
        }

        .referral-row:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .referral-row.pending {
            border-color: var(--gold);
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.1) 0%, var(--dark-secondary) 100%);
            animation: glow-gold 2s infinite;
        }

        @keyframes glow-gold {
            0%, 100% { box-shadow: 0 0 5px rgba(212, 175, 55, 0.3); }
            50% { box-shadow: 0 0 20px rgba(212, 175, 55, 0.5); }
        }

        .referral-row.successful {
            border-color: var(--success);
        }

        /* Referrer Info */
        .referrer-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .referrer-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--dark-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: calc(18px * var(--mobile-font-scale, 1));
            border: 2px solid var(--gold);
        }

        .referrer-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .referrer-name {
            font-weight: 600;
            font-size: calc(14px * var(--mobile-font-scale, 1));
        }

        .referrer-code {
            font-size: calc(11px * var(--mobile-font-scale, 1));
            color: var(--text-secondary);
        }

        /* Referred Friend */
        .referred-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .referred-name {
            font-weight: 500;
            font-size: calc(14px * var(--mobile-font-scale, 1));
        }

        .referred-date {
            font-size: calc(11px * var(--mobile-font-scale, 1));
            color: var(--text-secondary);
        }

        /* Status Badge */
        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: calc(12px * var(--mobile-font-scale, 1));
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-badge.pending {
            background: rgba(255, 152, 0, 0.2);
            color: var(--pending);
            border: 1px solid var(--pending);
        }

        .status-badge.successful {
            background: rgba(0, 204, 0, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        /* Milestone Tracker */
        .milestone-tracker {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .milestone-text {
            font-size: calc(12px * var(--mobile-font-scale, 1));
            font-weight: 500;
        }

        .milestone-text.claimed {
            color: var(--success);
        }

        .milestone-text.progress {
            color: var(--gold);
        }

        .milestone-progress {
            width: 100%;
            height: 4px;
            background: var(--dark-tertiary);
            border-radius: 2px;
            overflow: hidden;
        }

        .milestone-progress-bar {
            height: 100%;
            background: var(--gold);
            border-radius: 2px;
            transition: width 0.3s;
        }

        /* Verify Button */
        .verify-btn {
            padding: 8px 16px;
            background: var(--gold);
            color: var(--dark);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: calc(12px * var(--mobile-font-scale, 1));
            cursor: pointer;
            transition: all 0.3s;
        }

        .verify-btn:hover {
            background: var(--gold-light);
            transform: translateY(-2px);
        }

        .verify-btn:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        /* 3-Dot Menu */
        .options-menu {
            position: relative;
        }

        .options-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: calc(20px * var(--mobile-font-scale, 1));
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .options-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--dark-tertiary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            min-width: 180px;
            display: none;
            z-index: 100;
            overflow: hidden;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background 0.3s;
            font-size: calc(13px * var(--mobile-font-scale, 1));
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .dropdown-item.reward {
            color: var(--gold);
        }

        .dropdown-item.delete {
            color: var(--danger);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: calc(60px * var(--mobile-font-scale, 1));
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: calc(18px * var(--mobile-font-scale, 1));
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        /* Mobile Responsive */
        @media (max-width: 1200px) {
            .referral-row {
                grid-template-columns: 100px 1fr 100px 100px 40px;
            }
            .milestone-tracker {
                display: none;
            }
        }

        @media (max-width: 900px) {
            .page-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            .referral-row {
                grid-template-columns: 1fr 1fr 80px 40px;
                gap: 10px;
            }
            .referrer-info {
                flex-direction: column;
                align-items: flex-start;
            }
            .status-badge {
                font-size: calc(10px * var(--mobile-font-scale, 1));
                padding: 4px 10px;
            }
            .verify-btn {
                padding: 6px 10px;
                font-size: calc(10px * var(--mobile-font-scale, 1));
            }
        }

        @media (max-width: 600px) {
            .stats-row {
                grid-template-columns: 1fr 1fr;
            }
            .referral-row {
                grid-template-columns: 1fr 1fr 40px;
            }
            .referred-info {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Header -->
        <div class="page-header">
            <div class="header-left">
                <a href="/admin" class="back-btn">‚Üê Dashboard</a>
                <h1 class="page-title">üéÅ REFERRAL MANAGEMENT</h1>
            </div>
            <div class="header-right">
                <span class="admin-badge">ADMIN</span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Stats Row -->
            <div class="stats-row">
                <div class="stat-card highlight">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-value" id="totalReferrals">0</div>
                    <div class="stat-label">Total Referrals</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-value" id="successfulReferrals">0</div>
                    <div class="stat-label">Successful</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚è≥</div>
                    <div class="stat-value" id="pendingReferrals">0</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üéâ</div>
                    <div class="stat-value" id="rewardsClaimed">0</div>
                    <div class="stat-label">Rewards Claimed</div>
                </div>
            </div>

            <!-- Pending Claims Alert -->
            <div class="pending-alert" id="pendingAlert" style="display: none;">
                <span class="pending-alert-text">‚ö†Ô∏è Pending Reward Claims</span>
                <span class="pending-count" id="pendingCount">0</span>
            </div>

            <!-- Referral Activity Stack -->
            <div class="activity-section">
                <h2 class="section-title">üìã REFERRAL ACTIVITY</h2>
                <div class="referral-list" id="referralList">
                    <!-- Loading State -->
                    <div class="empty-state">
                        <div class="empty-icon">‚è≥</div>
                        <div class="empty-title">Loading referrals...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dropdown Menu Template -->
    <template id="dropdownTemplate">
        <div class="dropdown-menu">
            <div class="dropdown-item reward" onclick="openRewardModal('{{id}}', '30off')">
                <span>üé´</span> Grant 30% Off
            </div>
            <div class="dropdown-item reward" onclick="openRewardModal('{{id}}', 'freecut')">
                <span>‚úÇÔ∏è</span> Grant Free Cut
            </div>
            <div class="dropdown-item delete" onclick="deleteReferral('{{id}}')">
                <span>üóëÔ∏è</span> Delete Entry
            </div>
        </div>
    </template>

    <script>
        // Load referrals on page load
        document.addEventListener('DOMContentLoaded', loadReferrals);

        async function loadReferrals() {
            try {
                const response = await fetch('/api/admin/referrals');
                const result = await response.json();
                
                if (result.success) {
                    renderReferrals(result.data);
                    updateStats(result.data);
                } else {
                    showEmptyState();
                }
            } catch (error) {
                console.error('Error loading referrals:', error);
                showEmptyState();
            }
        }

        function renderReferrals(referrals) {
            const container = document.getElementById('referralList');
            
            if (!referrals || referrals.length === 0) {
                showEmptyState();
                return;
            }

            container.innerHTML = referrals.map(ref => {
                const status = ref.status || 'pending';
                const statusClass = status === 'successful' ? 'successful' : 'pending';
                const statusText = status === 'successful' ? 'Successful' : 'Pending';
                
                // Milestone progress
                const progress = ref.referral_count || 0;
                const progressPercent = Math.min((progress / 3) * 100, 100);
                let milestoneText = `${progress}/3 Progress`;
                let milestoneClass = 'progress';
                
                if (ref.last_claimed) {
                    milestoneText = ref.last_claimed === 'freecut' ? 'üéâ Free Cut Earned!' : 'üé´ 30% Claimed';
                    milestoneClass = 'claimed';
                }

                return `
                    <div class="referral-row ${statusClass}" data-id="${ref.id}">
                        <div class="referrer-info">
                            <div class="referrer-avatar">
                                ${ref.referrer_photo ? `<img src="${ref.referrer_photo}" alt="${ref.referrer_name}">` : 'üë§'}
                            </div>
                            <div>
                                <div class="referrer-name">${ref.referrer_name || 'Unknown'}</div>
                                <div class="referrer-code">${ref.referrer_code || ''}</div>
                            </div>
                        </div>
                        
                        <div class="referred-info">
                            <div class="referred-name">${ref.referred_name || 'Unknown Friend'}</div>
                            <div class="referred-date">${formatDate(ref.created_at)}</div>
                        </div>
                        
                        <div>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        
                        <div class="milestone-tracker">
                            <div class="milestone-text ${milestoneClass}">${milestoneText}</div>
                            <div class="milestone-progress">
                                <div class="milestone-progress-bar" style="width: ${progressPercent}%"></div>
                            </div>
                        </div>
                        
                        <button class="verify-btn" 
                                onclick="verifyReferral('${ref.id}')"
                                ${status === 'successful' ? 'disabled' : ''}>
                            ${status === 'successful' ? '‚úì Verified' : 'Verify'}
                        </button>
                        
                        <div class="options-menu">
                            <button class="options-btn" onclick="toggleDropdown('${ref.id}')">‚ãÆ</button>
                            <div class="dropdown-menu" id="dropdown-${ref.id}">
                                <div class="dropdown-item reward" onclick="openRewardModal('${ref.id}', '30off')">
                                    <span>üé´</span> Grant 30% Off
                                </div>
                                <div class="dropdown-item reward" onclick="openRewardModal('${ref.id}', 'freecut')">
                                    <span>‚úÇÔ∏è</span> Grant Free Cut
                                </div>
                                <div class="dropdown-item delete" onclick="deleteReferral('${ref.id}')">
                                    <span>üóëÔ∏è</span> Delete Entry
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateStats(referrals) {
            const total = referrals.length;
            const successful = referrals.filter(r => r.status === 'successful').length;
            const pending = total - successful;
            const claimed = referrals.filter(r => r.last_claimed).length;

            document.getElementById('totalReferrals').textContent = total;
            document.getElementById('successfulReferrals').textContent = successful;
            document.getElementById('pendingReferrals').textContent = pending;
            document.getElementById('rewardsClaimed').textContent = claimed;

            // Show pending alert if there are pending claims
            const pendingAlert = document.getElementById('pendingAlert');
            if (pending > 0) {
                pendingAlert.style.display = 'flex';
                document.getElementById('pendingCount').textContent = pending;
            } else {
                pendingAlert.style.display = 'none';
            }
        }

        function showEmptyState() {
            const container = document.getElementById('referralList');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üéÅ</div>
                    <div class="empty-title">No Referrals Yet</div>
                    <p>Referrals will appear here when users invite friends</p>
                </div>
            `;
            document.getElementById('totalReferrals').textContent = '0';
            document.getElementById('successfulReferrals').textContent = '0';
            document.getElementById('pendingReferrals').textContent = '0';
            document.getElementById('rewardsClaimed').textContent = '0';
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown date';
            const date = new Date(timestamp * 1000);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function toggleDropdown(id) {
            // Close all other dropdowns
            document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                if (menu.id !== `dropdown-${id}`) {
                    menu.classList.remove('show');
                }
            });
            
            const dropdown = document.getElementById(`dropdown-${id}`);
            dropdown.classList.toggle('show');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.options-menu')) {
                document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });

        async function verifyReferral(id) {
            if (!confirm('Verify this referral as legitimate?')) return;
            
            try {
                const response = await fetch('/api/admin/referrals/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ referral_id: id })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Referral verified successfully!');
                    loadReferrals();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error verifying referral:', error);
                alert('Error verifying referral');
            }
        }

        function openRewardModal(id, rewardType) {
            const typeText = rewardType === '30off' ? '30% Off Discount' : 'Free Cut';
            if (!confirm(`Manually grant ${typeText} to this referral?`)) return;
            
            grantReward(id, rewardType);
        }

        async function grantReward(id, rewardType) {
            try {
                const response = await fetch('/api/admin/referrals/reward', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ referral_id: id, reward_type: rewardType })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Reward granted successfully!');
                    loadReferrals();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error granting reward:', error);
                alert('Error granting reward');
            }
        }

        async function deleteReferral(id) {
            if (!confirm('Are you sure you want to delete this referral entry? This cannot be undone.')) return;
            
            try {
                const response = await fetch('/api/admin/referrals/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ referral_id: id })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Referral deleted successfully!');
                    loadReferrals();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error deleting referral:', error);
                alert('Error deleting referral');
            }
        }

        // Auto-refresh every 30 seconds
        setInterval(loadReferrals, 30000);
    </script>
</body>
</html>
