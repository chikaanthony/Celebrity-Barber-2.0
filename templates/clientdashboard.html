<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Dashboard - Celebrity Barber</title>

    <link rel="stylesheet" href="../static/style.css">
    <link rel="stylesheet" href="../static/clientdashboard.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Orbitron:wght@500;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>

    <!-- Navigation Bar -->
    <nav class="client-nav">
        <div class="nav-logo">
            <span class="logo-icon">‚úÇÔ∏è</span>
            <span class="logo-text">CELEBRITY BARBER</span>
        </div>
        
        <div class="nav-right">
            <button class="notification-btn" onclick="window.location.href='/notifications'">
                <span class="notif-icon">üîî</span>
                <span class="notif-badge" id="notifBadge">0</span>
            </button>
            <button class="menu-dots" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <button class="close-menu" onclick="toggleMobileMenu()">√ó</button>
        <a href="/clientdashboard">My Account</a>
        <a href="/settings">Settings</a>
        <a href="#">Help</a>
        <a href="/logout">Logout</a>
    </div>

    <!-- Profile Section -->
    <div class="profile-section">
        <div class="profile-container">
            <div class="profile-pic" onclick="window.location.href='/profile'">
                <span class="avatar" id="dashboardAvatar">üë§</span>
                <button class="change-pic">üì∑</button>
            </div>
            <h1>WELCOME BACK CELEB <span class="user-name">{{ user.full_name if user else 'User' }}</span></h1>
            <div class="vip-indicator" id="vipIndicator" style="{{ '' if user and user.is_vip else 'display:none;' }}">
                <span class="vip-badge" id="vipBadge">üëë VIP</span>
                <span class="vip-status" id="vipStatus">{{ 'Active VIP' if user and user.is_vip else '' }}</span>
            </div>
            <p class="user-email">{{ user.email if user else 'user@example.com' }}</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="dashboard-content">
        <!-- Latest Updates -->
        <div class="dashboard-card updates-card">
            <h3>LATEST UPDATES</h3>
            <div class="updates-ticker" id="updatesTicker">
                <div class="ticker-track" id="updatesTrack">
                    <article class="update-slide active">
                        <div class="update-media update-media-placeholder">NEWS</div>
                        <div class="update-content">
                            <h4>Welcome</h4>
                            <p>Latest announcements will appear here.</p>
                            <span class="update-time">Just now</span>
                        </div>
                    </article>
                </div>
                <div class="update-dots" id="updateDots"></div>
            </div>
        </div>
        <!-- Spending Streak - loads from database -->
        <div class="dashboard-card spending-card">
            <h3>üí∞ SPENDING STREAK BONUS</h3>
            <div class="spending-content">
                <div class="pie-chart-container">
                    <svg class="pie-chart" viewBox="0 0 100 100">
                        <circle class="pie-bg" cx="50" cy="50" r="40"/>
                        <circle class="pie-fill" cx="50" cy="50" r="40" id="spendingPie" stroke-dasharray="0 251.2"/>
                        <text x="50" y="45" class="pie-text" text-anchor="middle" id="spendingAmount">‚Ç¶0</text>
                        <text x="50" y="60" class="pie-subtext" text-anchor="middle">of ‚Ç¶5,000</text>
                    </svg>
                </div>
                <div class="spending-info">
                    <p class="spending-goal">Reach ‚Ç¶5,000 spending to unlock ‚Ç¶500 bonus!</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="spendingProgress" style="width: 0%;"></div>
                    </div>
                    <p class="spending-hint" id="spendingHint">Start booking to earn bonuses</p>
                </div>
            </div>
        </div>
        
    <!-- Referral Streak -->
        <div class="dashboard-card" onclick="window.location.href='/referrals'" style="cursor: pointer; transition: all 0.3s; border: 1px solid #1a1a1a; background: #111; border-radius: 16px; padding: 20px; margin-bottom: 20px;">
            <h3 style="font-family: 'Orbitron', sans-serif; color: #d4af37; font-size: calc(14px * var(--mobile-font-scale, 1)); margin-bottom: 15px;">üéÅ REFERRAL STREAK</h3>
            <div style="padding: 10px 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div id="dash-m1" style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                        <div id="dash-m1-circle" style="width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: calc(18px * var(--mobile-font-scale, 1)); border: 2px solid rgba(255,255,255,0.2); margin-bottom: 5px; transition: all 0.3s;">üéüÔ∏è</div>
                        <span id="dash-m1-label" style="color: #aaa; font-size: calc(10px * var(--mobile-font-scale, 1)); text-align: center;">30% OFF</span>
                    </div>
                    <div class="dash-m-line"></div>
                    <div id="dash-m2" style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                        <div id="dash-m2-circle" style="width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: calc(18px * var(--mobile-font-scale, 1)); border: 2px solid rgba(255,255,255,0.2); margin-bottom: 5px; transition: all 0.3s;">üéüÔ∏è</div>
                        <span id="dash-m2-label" style="color: #aaa; font-size: calc(10px * var(--mobile-font-scale, 1)); text-align: center;">60% OFF</span>
                    </div>
                    <div class="dash-m-line"></div>
                    <div id="dash-m3" style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                        <div id="dash-m3-circle" style="width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: calc(18px * var(--mobile-font-scale, 1)); border: 2px solid rgba(255,255,255,0.2); margin-bottom: 5px; transition: all 0.3s;">‚úÇÔ∏è</div>
                        <span id="dash-m3-label" style="color: #aaa; font-size: calc(10px * var(--mobile-font-scale, 1)); text-align: center;">FREE CUT</span>
                    </div>
                </div>
                <p id="referralStreakHint" style="text-align: center; color: #888; font-size: calc(13px * var(--mobile-font-scale, 1));">Refer friends to unlock rewards!</p>
            </div>
        </div>

        <!-- History Section -->
        <div class="dashboard-card history-card">
            <h3>üìã MY HISTORY</h3>
            <div class="history-list">
                <div class="history-item" onclick="window.location.href='/bookings'">
                    <div class="history-icon">üìÖ</div>
                    <div class="history-info">
                        <h4>Booking History</h4>
                        <p>View your past appointments</p>
                    </div>
                    <span class="history-arrow">‚Ä∫</span>
                </div>
                <div class="history-item" onclick="window.location.href='/referrals'">
                    <div class="history-icon">üéÅ</div>
                    <div class="history-info">
                        <h4>Referral History</h4>
                        <p>Track your referrals</p>
                    </div>
                    <span class="history-arrow">‚Ä∫</span>
                </div>
                <div class="history-item" onclick="window.location.href='/transactions'">
                    <div class="history-icon">üí≥</div>
                    <div class="history-info">
                        <h4>Transaction History</h4>
                        <p>View all transactions</p>
                    </div>
                    <span class="history-arrow">‚Ä∫</span>
                </div>
            </div>
        </div>
    </div>
    <!-- Floating Message Button -->
    <div class="floating-message">
        <button class="message-btn" onclick="window.location.href='/chat'">
            <span>&#128172;</span>
        </button>
        <span class="message-badge" id="chatPendingBadge" style="display:none;">0</span>
    </div>
    <!-- Bottom Navigation Bar -->
    <div class="bottom-nav">
        <button class="nav-item" onclick="window.location.href='/bookcut'">
            <span class="nav-icon">‚úÇÔ∏è</span>
            <span>Book a Cut</span>
        </button>
        <button class="nav-item" onclick="window.location.href='/joinvip'">
            <span class="nav-icon">üëë</span>
            <span>Join VIP</span>
        </button>
        <button class="nav-item" onclick="window.location.href='/refer'">
            <span class="nav-icon">üéÅ</span>
            <span>Refer Friend</span>
        </button>
        <button class="nav-item" onclick="window.location.href='/reviews'">
            <span class="nav-icon">‚≠ê</span>
            <span>Reviews</span>
        </button>
        <button class="nav-item" onclick="window.location.href='/leaderboard'">
            <span class="nav-icon">üèÜ</span>
            <span>Leaderboard</span>
        </button>
    </div>

    <!-- Popup Overlays -->
    
    <!-- Update Popup -->
    <div class="popup-overlay" id="update-popup">
        <div class="popup-content">
            <button class="popup-close" onclick="closePopup('update-popup')">‚Üê Return</button>
            <h2>üì¢ Announcement</h2>
            <div class="popup-body" id="update-popup-body">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        let currentReferralCount = 0;
        let updatesTimer = null;
        let currentUpdateIndex = 0;
        let vipCounterTimer = null;
        let suppressNextUpdateTap = false;
        let updatesGestureBound = false;
        window.broadcastsData = [];

        async function loadNotificationCount() {
            try {
                const response = await fetch('/api/user/notifications');
                const result = await response.json();

                if (result.success && Array.isArray(result.data)) {
                    const unreadCount = result.data.filter(n => n.unread === true).length;
                    const badge = document.getElementById('notifBadge');
                    if (badge) {
                        badge.textContent = unreadCount;
                        badge.style.display = unreadCount > 0 ? 'flex' : 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        async function loadPendingChatReplies() {
            try {
                const response = await fetch('/api/chat/pending-replies');
                const result = await response.json();
                const badge = document.getElementById('chatPendingBadge');
                if (!badge) return;

                if (result.success && Number(result.pending_count || 0) > 0) {
                    const count = Number(result.pending_count || 0);
                    badge.textContent = count > 99 ? '99+' : String(count);
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading pending chat replies:', error);
            }
        }

        async function sendHeartbeat() {
            try {
                await fetch('/api/user/heartbeat', { method: 'POST' });
            } catch (e) {
                // no-op
            }
        }

        window.updateNotificationBadge = function(count) {
            const badge = document.getElementById('notifBadge');
            if (badge) {
                badge.textContent = count;
                badge.style.display = count > 0 ? 'flex' : 'none';
            }
        };

        async function loadUserSpending() {
            try {
                const response = await fetch('/api/user/spending');
                const result = await response.json();

                if (result.success) {
                    updateSpendingDisplay(result.total_spent);
                }
            } catch (error) {
                console.error('Error loading spending:', error);
            }
        }

        function applyProfilePhoto(photoUrl) {
            const avatarEl = document.getElementById('dashboardAvatar');
            if (!avatarEl) return;

            let img = document.getElementById('dashboardAvatarImg');

            if (photoUrl) {
                if (!img) {
                    img = document.createElement('img');
                    img.id = 'dashboardAvatarImg';
                    img.alt = 'Profile photo';
                    img.style.cssText = 'width: 100%; height: 100%; object-fit: cover; border-radius: 50%;';
                    avatarEl.parentNode.appendChild(img);
                }
                img.src = photoUrl;
                img.style.display = 'block';
                avatarEl.style.display = 'none';
            } else {
                if (img) {
                    img.style.display = 'none';
                }
                avatarEl.style.display = 'flex';
            }
        }

        async function loadUserProfile() {
            try {
                const [profileResponse, referralsResponse] = await Promise.all([
                    fetch('/api/user/profile'),
                    fetch('/api/user/referrals')
                ]);

                const profileResult = await profileResponse.json();
                const referralsResult = await referralsResponse.json();
                let profileReferralCount = 0;
                let historyReferralCount = 0;

                if (profileResult.success && profileResult.data) {
                    const isVIP = profileResult.data.is_vip === true || profileResult.data.isVIP === true;
                    const vipExpiresAt =
                        profileResult.data.vip_expires ||
                        profileResult.data.vipExpires ||
                        profileResult.data.vip_expires_at ||
                        null;
                    updateVIPStatus(isVIP, vipExpiresAt);
                    const rawProfileCount =
                        profileResult.data.referral_count ??
                        profileResult.data.referrals_count ??
                        profileResult.data.total_referrals ??
                        profileResult.data.referral_streak ??
                        0;
                    profileReferralCount = Number(rawProfileCount) || 0;

                    const photoUrl =
                        profileResult.data.photo_url ||
                        profileResult.data.profile_photo ||
                        profileResult.data.profilePhoto ||
                        profileResult.data.photo ||
                        profileResult.data.avatar ||
                        sessionStorage.getItem('profilePhoto') ||
                        '';
                    applyProfilePhoto(photoUrl);
                }

                if (referralsResult.success && Array.isArray(referralsResult.data)) {
                    historyReferralCount = referralsResult.data.length;
                }

                currentReferralCount = Math.max(profileReferralCount, historyReferralCount, 0);
                updateReferralStreak(currentReferralCount);
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        function parseDateValue(value) {
            if (!value) return null;

            if (value instanceof Date) {
                return Number.isNaN(value.getTime()) ? null : value;
            }

            if (typeof value === 'string' || typeof value === 'number') {
                const parsed = new Date(value);
                return Number.isNaN(parsed.getTime()) ? null : parsed;
            }

            if (typeof value === 'object') {
                if (typeof value.toDate === 'function') {
                    const converted = value.toDate();
                    return Number.isNaN(converted.getTime()) ? null : converted;
                }
                const seconds = value._seconds ?? value.seconds;
                if (typeof seconds === 'number') {
                    const converted = new Date(seconds * 1000);
                    return Number.isNaN(converted.getTime()) ? null : converted;
                }
            }

            return null;
        }

        function buildVipCounterText(vipExpiresAt) {
            const expiryDate = parseDateValue(vipExpiresAt);
            if (!expiryDate) return 'Active VIP';

            const now = new Date();
            const msDiff = expiryDate.getTime() - now.getTime();
            const dateLabel = expiryDate.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });

            if (msDiff <= 0) {
                return `Active VIP - Expired ${dateLabel}`;
            }

            const dayMs = 24 * 60 * 60 * 1000;
            const daysLeft = Math.ceil(msDiff / dayMs);
            return `Active VIP - ${daysLeft}d left (${dateLabel})`;
        }

        function startVipCounter(vipExpiresAt) {
            if (vipCounterTimer) {
                clearInterval(vipCounterTimer);
                vipCounterTimer = null;
            }

            const render = () => {
                const vipStatus = document.getElementById('vipStatus');
                if (vipStatus) {
                    vipStatus.textContent = buildVipCounterText(vipExpiresAt);
                }
            };

            render();
            vipCounterTimer = setInterval(render, 60 * 1000);
        }

        function getReferralThemePalette() {
            const isLight = document.documentElement.getAttribute('data-theme') === 'light';
            return {
                inactiveBg: isLight ? 'rgba(15, 23, 42, 0.06)' : 'rgba(255,255,255,0.1)',
                inactiveBorder: isLight ? 'rgba(15, 23, 42, 0.16)' : 'rgba(255,255,255,0.2)',
                inactiveLabel: isLight ? '#64748b' : '#aaa',
                activeBg: 'rgba(212, 175, 55, 0.28)',
                activeBorder: '#d4af37',
                activeLabel: isLight ? '#8a6a15' : '#d4af37'
            };
        }

        function updateReferralStreak(count) {
            const m1Circle = document.getElementById('dash-m1-circle');
            const m1Label = document.getElementById('dash-m1-label');
            const m2Circle = document.getElementById('dash-m2-circle');
            const m2Label = document.getElementById('dash-m2-label');
            const m3Circle = document.getElementById('dash-m3-circle');
            const m3Label = document.getElementById('dash-m3-label');
            const hint = document.getElementById('referralStreakHint');
            const palette = getReferralThemePalette();
            const total = Math.max(0, Number(count) || 0);
            const cycleProgress = total % 3;
            const completedCycles = Math.floor(total / 3);

            if (m1Circle) { m1Circle.style.background = palette.inactiveBg; m1Circle.style.borderColor = palette.inactiveBorder; }
            if (m1Label) m1Label.style.color = palette.inactiveLabel;
            if (m2Circle) { m2Circle.style.background = palette.inactiveBg; m2Circle.style.borderColor = palette.inactiveBorder; }
            if (m2Label) m2Label.style.color = palette.inactiveLabel;
            if (m3Circle) { m3Circle.style.background = palette.inactiveBg; m3Circle.style.borderColor = palette.inactiveBorder; }
            if (m3Label) m3Label.style.color = palette.inactiveLabel;

            if (cycleProgress >= 1) {
                if (m1Circle) { m1Circle.style.background = palette.activeBg; m1Circle.style.borderColor = palette.activeBorder; }
                if (m1Label) m1Label.style.color = palette.activeLabel;
            }
            if (cycleProgress >= 2) {
                if (m2Circle) { m2Circle.style.background = palette.activeBg; m2Circle.style.borderColor = palette.activeBorder; }
                if (m2Label) m2Label.style.color = palette.activeLabel;
            }
            if (hint) {
                if (total > 0 && cycleProgress === 0) {
                    hint.textContent = `${completedCycles} FREE CUT reward${completedCycles > 1 ? 's' : ''} unlocked. New cycle started.`;
                } else if (cycleProgress >= 1) {
                    hint.textContent = `${3 - cycleProgress} more referral(s) to get a FREE CUT!`;
                } else {
                    hint.textContent = 'Refer friends to unlock rewards!';
                }
            }
        }

        function observeThemeChanges() {
            const observer = new MutationObserver(() => {
                updateReferralStreak(currentReferralCount);
            });
            observer.observe(document.documentElement, {
                attributes: true,
                attributeFilter: ['data-theme']
            });
        }

        function bindUpdatesSwipe() {
            if (updatesGestureBound) return;

            const ticker = document.getElementById('updatesTicker');
            if (!ticker) return;

            updatesGestureBound = true;
            const SWIPE_THRESHOLD = 48;
            const TAP_MOVE_LIMIT = 10;
            let tracking = false;
            let startX = 0;
            let startY = 0;
            let deltaX = 0;
            let deltaY = 0;

            const pauseAutoplay = () => {
                if (updatesTimer) {
                    clearInterval(updatesTimer);
                    updatesTimer = null;
                }
            };

            const begin = (x, y) => {
                tracking = true;
                startX = x;
                startY = y;
                deltaX = 0;
                deltaY = 0;
                ticker.classList.add('is-grabbing');
                pauseAutoplay();
            };

            const move = (x, y) => {
                if (!tracking) return;
                deltaX = x - startX;
                deltaY = y - startY;
                if (Math.abs(deltaX) > TAP_MOVE_LIMIT || Math.abs(deltaY) > TAP_MOVE_LIMIT) {
                    suppressNextUpdateTap = true;
                }
            };

            const end = () => {
                if (!tracking) return;
                tracking = false;
                ticker.classList.remove('is-grabbing');

                const horizontalSwipe = Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) >= SWIPE_THRESHOLD;
                if (horizontalSwipe && Array.isArray(window.broadcastsData) && window.broadcastsData.length > 1) {
                    if (deltaX < 0) {
                        activateUpdateSlide(currentUpdateIndex + 1, true);
                    } else {
                        activateUpdateSlide(currentUpdateIndex - 1, true);
                    }
                    setTimeout(() => {
                        suppressNextUpdateTap = false;
                    }, 180);
                } else {
                    startUpdatesCarousel();
                    if (Math.abs(deltaX) <= TAP_MOVE_LIMIT && Math.abs(deltaY) <= TAP_MOVE_LIMIT) {
                        suppressNextUpdateTap = false;
                    }
                }

                deltaX = 0;
                deltaY = 0;
            };

            ticker.addEventListener('touchstart', (event) => {
                if (!event.touches || event.touches.length !== 1) return;
                const touch = event.touches[0];
                begin(touch.clientX, touch.clientY);
            }, { passive: true });

            ticker.addEventListener('touchmove', (event) => {
                if (!tracking || !event.touches || event.touches.length !== 1) return;
                const touch = event.touches[0];
                move(touch.clientX, touch.clientY);
                if (Math.abs(deltaX) > Math.abs(deltaY)) {
                    event.preventDefault();
                }
            }, { passive: false });

            ticker.addEventListener('touchend', () => {
                end();
            }, { passive: true });

            ticker.addEventListener('touchcancel', () => {
                end();
            }, { passive: true });

            ticker.addEventListener('mousedown', (event) => {
                if (event.button !== 0) return;
                begin(event.clientX, event.clientY);
            });

            window.addEventListener('mousemove', (event) => {
                move(event.clientX, event.clientY);
            });

            window.addEventListener('mouseup', () => {
                end();
            });

            ticker.addEventListener('click', (event) => {
                if (suppressNextUpdateTap) {
                    event.preventDefault();
                    event.stopPropagation();
                    suppressNextUpdateTap = false;
                    return;
                }

                const activeSlide = ticker.querySelector('.update-slide.active');
                const fallbackIndex = Number(currentUpdateIndex) || 0;
                const indexAttr = activeSlide ? Number(activeSlide.getAttribute('data-index')) : fallbackIndex;
                const targetIndex = Number.isFinite(indexAttr) ? indexAttr : fallbackIndex;
                showBroadcastPopup(targetIndex);
            });
        }

        async function loadBroadcasts() {
            try {
                const response = await fetch('/api/broadcasts');
                const result = await response.json();

                if (result.success && Array.isArray(result.data) && result.data.length > 0) {
                    updateLatestUpdates(result.data);
                } else {
                    updateLatestUpdates([]);
                }
            } catch (error) {
                console.error('Error loading broadcasts:', error);
                updateLatestUpdates([]);
            }
        }

        function parseBroadcastDate(value) {
            if (!value) return null;

            if (typeof value === 'number') {
                const ms = value > 1_000_000_000_000 ? value : value * 1000;
                const date = new Date(ms);
                return Number.isNaN(date.getTime()) ? null : date;
            }

            if (typeof value === 'string') {
                const date = new Date(value);
                return Number.isNaN(date.getTime()) ? null : date;
            }

            if (typeof value === 'object') {
                if (typeof value.toDate === 'function') {
                    const date = value.toDate();
                    return Number.isNaN(date.getTime()) ? null : date;
                }
                const seconds = value._seconds || value.seconds;
                if (typeof seconds === 'number') {
                    const date = new Date(seconds * 1000);
                    return Number.isNaN(date.getTime()) ? null : date;
                }
            }

            return null;
        }

        function formatBroadcastDate(value) {
            const date = parseBroadcastDate(value);
            if (!date) return 'Recent';
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function updateLatestUpdates(broadcasts) {
            const track = document.getElementById('updatesTrack');
            const dots = document.getElementById('updateDots');
            if (!track || !dots) return;

            if (updatesTimer) {
                clearInterval(updatesTimer);
                updatesTimer = null;
            }

            const cleanBroadcasts = Array.isArray(broadcasts) ? broadcasts.filter(Boolean) : [];
            window.broadcastsData = cleanBroadcasts;

            if (cleanBroadcasts.length === 0) {
                track.innerHTML = `
                    <article class="update-slide active">
                        <div class="update-media update-media-placeholder">NEWS</div>
                        <div class="update-content">
                            <h4>No Updates Yet</h4>
                            <p>Announcements from the team will appear here.</p>
                            <span class="update-time">Now</span>
                        </div>
                    </article>
                `;
                dots.innerHTML = '';
                return;
            }

            track.innerHTML = cleanBroadcasts.map((broadcast, index) => {
                const title = String(broadcast.title || 'Announcement');
                const content = String(broadcast.content || '');
                const timeLabel = formatBroadcastDate(broadcast.createdAt || broadcast.created_at || broadcast.created_at_iso);
                const media = broadcast.image
                    ? `<img class="update-media" src="${broadcast.image}" alt="Announcement image">`
                    : '<div class="update-media update-media-placeholder">NEWS</div>';

                return `
                    <article class="update-slide ${index === 0 ? 'active' : ''}" data-index="${index}">
                        ${media}
                        <div class="update-content">
                            <h4>${title}</h4>
                            <p>${content}</p>
                            <span class="update-time">${timeLabel}</span>
                        </div>
                    </article>
                `;
            }).join('');

            dots.innerHTML = cleanBroadcasts.map((_, index) => `
                <button type="button" class="update-dot ${index === 0 ? 'active' : ''}" onclick="event.stopPropagation(); activateUpdateSlide(${index}, true)"></button>
            `).join('');

            currentUpdateIndex = 0;
            startUpdatesCarousel();
        }

        function activateUpdateSlide(index, restartTimer = false) {
            const slides = document.querySelectorAll('#updatesTrack .update-slide');
            const dots = document.querySelectorAll('#updateDots .update-dot');
            if (!slides.length) return;

            const max = slides.length;
            const nextIndex = ((index % max) + max) % max;
            currentUpdateIndex = nextIndex;

            slides.forEach((slide, i) => {
                slide.classList.toggle('active', i === nextIndex);
            });

            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === nextIndex);
            });

            if (restartTimer) {
                startUpdatesCarousel();
            }
        }

        function startUpdatesCarousel() {
            if (updatesTimer) {
                clearInterval(updatesTimer);
                updatesTimer = null;
            }

            const slides = document.querySelectorAll('#updatesTrack .update-slide');
            if (slides.length <= 1) return;

            updatesTimer = setInterval(() => {
                activateUpdateSlide(currentUpdateIndex + 1);
            }, 6500);
        }

        function showBroadcastPopup(index) {
            const broadcast = window.broadcastsData[index];
            if (!broadcast) return;

            const popupBody = document.getElementById('update-popup-body');
            let html = '';

            if (broadcast.image) {
                html += `<img src="${broadcast.image}" alt="Update Image" style="width:100%;max-height:360px;object-fit:cover;border-radius:12px;margin-bottom:15px;">`;
            }

            html += `<h3>${broadcast.title || 'Announcement'}</h3>`;
            html += `<p>${broadcast.content || ''}</p>`;

            const dateLabel = formatBroadcastDate(broadcast.createdAt || broadcast.created_at || broadcast.created_at_iso);
            html += `<p class="popup-date">Posted: ${dateLabel}</p>`;

            popupBody.innerHTML = html;
            showPopup('update-popup');
        }

        function updateVIPStatus(isVIP, vipExpiresAt = null) {
            const vipIndicator = document.getElementById('vipIndicator');
            const vipBadge = document.getElementById('vipBadge');
            const vipStatus = document.getElementById('vipStatus');

            if (isVIP) {
                if (vipIndicator) vipIndicator.style.display = 'inline-flex';
                if (vipBadge) vipBadge.textContent = 'VIP';
                if (vipStatus) {
                    vipStatus.textContent = 'Active VIP';
                    vipStatus.style.display = 'inline';
                }
                startVipCounter(vipExpiresAt);
            } else {
                if (vipCounterTimer) {
                    clearInterval(vipCounterTimer);
                    vipCounterTimer = null;
                }
                if (vipIndicator) vipIndicator.style.display = 'none';
                if (vipStatus) {
                    vipStatus.textContent = '';
                    vipStatus.style.display = 'none';
                }
            }
        }

        function updateSpendingDisplay(totalSpent) {
            const goal = 5000;
            const bonusAmount = 500;
            const currentStreak = totalSpent % goal;
            const bonusesEarned = Math.floor(totalSpent / goal);
            const percentage = Math.min((currentStreak / goal) * 100, 100);
            const remaining = Math.max(goal - currentStreak, 0);

            const pie = document.getElementById('spendingPie');
            if (pie) {
                const dashValue = (percentage / 100) * 251.2;
                pie.setAttribute('stroke-dasharray', dashValue + ' 251.2');
            }

            const amountText = document.getElementById('spendingAmount');
            if (amountText) {
                amountText.textContent = 'NGN ' + currentStreak.toLocaleString();
            }

            const progress = document.getElementById('spendingProgress');
            if (progress) {
                progress.style.width = percentage + '%';
            }

            const hint = document.getElementById('spendingHint');
            if (hint) {
                if (bonusesEarned > 0) {
                    hint.textContent = `${bonusesEarned} bonus${bonusesEarned > 1 ? 'es' : ''} earned (NGN ${(bonusesEarned * bonusAmount).toLocaleString()})`;
                } else if (currentStreak >= goal) {
                    hint.textContent = 'Bonus unlocked!';
                } else {
                    hint.textContent = 'NGN ' + remaining.toLocaleString() + ' more to unlock bonus';
                }
            }
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('active');
        }

        function showPopup(popupId) {
            document.getElementById(popupId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closePopup(popupId) {
            document.getElementById(popupId).classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        loadUserSpending();
        loadUserProfile();
        loadNotificationCount();
        loadPendingChatReplies();
        sendHeartbeat();
        loadBroadcasts();
        bindUpdatesSwipe();
        observeThemeChanges();

        setInterval(sendHeartbeat, 60000);
        setInterval(loadPendingChatReplies, 15000);

        document.querySelectorAll('.popup-overlay').forEach(popup => {
            popup.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                    document.body.style.overflow = 'auto';
                }
            });
        });
    </script>
</body>
</html>


