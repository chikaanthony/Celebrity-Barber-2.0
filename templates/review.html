<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reviews - Celebrity Barber</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='review.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            background: #0a0a0a;
            min-height: 100vh;
            padding-bottom: calc(50px + env(safe-area-inset-bottom, 0px));
        }
        
        .reviews-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .close-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: calc(20px * var(--mobile-font-scale, 1));
            cursor: pointer;
            z-index: 100;
        }
        
        .close-btn:hover {
            background: rgba(212, 175, 55, 0.3);
        }
        
        .reviews-header {
            font-family: 'Orbitron', sans-serif;
            color: #d4af37;
            font-size: calc(28px * var(--mobile-font-scale, 1));
            text-align: center;
            margin: 30px 0 20px;
        }
        
        .header-separator {
            border: none;
            border-top: 2px solid rgba(212, 175, 55, 0.3);
            margin-bottom: 30px;
        }
        
        .reviews-feed {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .review-box {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .profile-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(212, 175, 55, 0.35);
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .profile-avatar .avatar-emoji {
            font-size: calc(25px * var(--mobile-font-scale, 1));
            line-height: 1;
        }
        
        .user-name {
            color: #fff;
            font-weight: 600;
            font-size: calc(15px * var(--mobile-font-scale, 1));
        }
        
        .review-date {
            color: #666;
            font-size: calc(12px * var(--mobile-font-scale, 1));
        }
        
        .review-content {
            color: #ccc;
            line-height: 1.6;
            margin-bottom: 15px;
            font-size: calc(14px * var(--mobile-font-scale, 1));
        }
        
        .review-actions {
            display: flex;
            gap: 15px;
        }
        
        .action-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #aaa;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: calc(13px * var(--mobile-font-scale, 1));
            transition: all 0.3s;
        }
        
        .action-btn:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: rgba(212, 175, 55, 0.3);
        }
        
        .action-btn.liked {
            color: #ff6b6b;
            border-color: rgba(255, 107, 107, 0.3);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state h2 {
            font-family: 'Orbitron', sans-serif;
            color: #d4af37;
            margin-bottom: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        /* Write Review Section */
        .write-review-section {
            margin-top: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .section-title {
            font-family: 'Orbitron', sans-serif;
            color: #d4af37;
            font-size: calc(18px * var(--mobile-font-scale, 1));
            margin-bottom: 15px;
        }
        
        .review-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .review-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            color: #fff;
            font-size: calc(14px * var(--mobile-font-scale, 1));
            font-family: 'Poppins', sans-serif;
            resize: vertical;
            min-height: 100px;
        }
        
        .review-input:focus {
            outline: none;
            border-color: #d4af37;
        }
        
        .review-input::placeholder {
            color: #666;
        }
        
        .submit-review-btn {
            background: linear-gradient(135deg, #d4af37 0%, #aa8a2e 100%);
            color: #0a0a0a;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-size: calc(16px * var(--mobile-font-scale, 1));
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Poppins', sans-serif;
        }
        
        .submit-review-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }
    </style>
</head>
<body>
    <div class="reviews-container">
        <!-- Close Button -->
        <button class="close-btn" onclick="window.location.href='/clientdashboard'">‚úï</button>
        
        <!-- Reviews Header -->
        <h1 class="reviews-header">REVIEWS</h1>
        <hr class="header-separator">
        
        <!-- Reviews Feed -->
        <div class="reviews-feed" id="reviewsFeed">
            <div class="loading">Loading reviews...</div>
        </div>
        
        <!-- Write Review Section -->
        <div class="write-review-section">
            <h2 class="section-title">üìù Write a Review</h2>
            <div class="review-form">
                <textarea 
                    class="review-input" 
                    id="reviewText" 
                    placeholder="Share your experience at Celebrity Barber..."
                    rows="4"
                ></textarea>
                <button class="submit-review-btn" onclick="submitReview()">Submit Review</button>
            </div>
        </div>
    </div>

    <script>
        function escapeHtml(value) {
            return String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function isImageSource(value) {
            const input = String(value || '').trim();
            return (
                input.startsWith('data:image/')
                || input.startsWith('http://')
                || input.startsWith('https://')
                || input.startsWith('/')
            );
        }

        function formatReviewDate(value) {
            if (!value) return 'Recent';
            if (typeof value === 'number') {
                const date = value > 10_000_000_000 ? new Date(value) : new Date(value * 1000);
                return Number.isNaN(date.getTime()) ? 'Recent' : date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            }
            if (typeof value === 'string') {
                const date = new Date(value);
                return Number.isNaN(date.getTime()) ? 'Recent' : date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            }
            if (typeof value === 'object') {
                if (typeof value.toDate === 'function') {
                    const date = value.toDate();
                    return Number.isNaN(date.getTime()) ? 'Recent' : date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                }
                const seconds = value._seconds || value.seconds;
                if (typeof seconds === 'number') {
                    const date = new Date(seconds * 1000);
                    return Number.isNaN(date.getTime()) ? 'Recent' : date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                }
            }
            return 'Recent';
        }

        function buildAvatarMarkup(review, name) {
            const photoCandidate =
                review.photo_url ||
                review.profile_photo ||
                review.profilePhoto ||
                '';

            if (isImageSource(photoCandidate)) {
                const safeUrl = escapeHtml(photoCandidate);
                const safeName = escapeHtml(name || 'Reviewer');
                return `<img src="${safeUrl}" alt="${safeName} profile photo">`;
            }

            const avatarText = (typeof review.avatar === 'string' && !isImageSource(review.avatar) && review.avatar.trim())
                ? review.avatar
                : 'üë®üèø';
            return `<span class="avatar-emoji">${escapeHtml(avatarText)}</span>`;
        }

        // Load reviews from API
        async function loadReviews() {
            try {
                const response = await fetch('/api/reviews');
                const result = await response.json();
                
                const feed = document.getElementById('reviewsFeed');
                
                if (result.success && result.data && result.data.length > 0) {
                    feed.innerHTML = result.data.map(review => {
                        const dateStr = formatReviewDate(review.createdAt);
                        const name = review.name || 'Anonymous';
                        const content = review.content || review.text || 'Great service!';
                        const avatarMarkup = buildAvatarMarkup(review, name);
                        const likes = review.likes || 0;
                        const replies = review.replies || 0;
                        
                        return `
                            <div class="review-box">
                                <div class="review-header">
                                    <div class="user-profile">
                                        <div class="profile-avatar">${avatarMarkup}</div>
                                        <span class="user-name">${escapeHtml(name)}</span>
                                    </div>
                                    <span class="review-date">${dateStr}</span>
                                </div>
                                <div class="review-content">
                                    <p>${escapeHtml(content)}</p>
                                </div>
                                <div class="review-actions">
                                    <button class="action-btn like-btn" onclick="toggleLike(this)">
                                        <span class="action-icon">‚ù§Ô∏è</span>
                                        <span class="action-count">${likes}</span>
                                    </button>
                                    <button class="action-btn reply-btn" onclick="focusReply(this)">
                                        <span class="action-icon">üí¨</span>
                                        <span class="action-count">${replies}</span>
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    feed.innerHTML = `
                        <div class="empty-state">
                            <h2>‚≠ê No Reviews Yet</h2>
                            <p>Be the first to leave a review!</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading reviews:', error);
                document.getElementById('reviewsFeed').innerHTML = `
                    <div class="empty-state">
                        <h2>‚ö†Ô∏è Error</h2>
                        <p>Failed to load reviews.</p>
                    </div>
                `;
            }
        }
        
        function toggleLike(btn) {
            btn.classList.toggle('liked');
            const count = btn.querySelector('.action-count');
            let num = parseInt(count.textContent);
            if (btn.classList.contains('liked')) {
                count.textContent = num + 1;
            } else {
                count.textContent = num - 1;
            }
        }
        
        function focusReply(btn) {
            alert('Reply feature coming soon!');
        }
        
        async function submitReview() {
            const text = document.getElementById('reviewText').value.trim();
            if (!text) {
                alert('Please write a review first!');
                return;
            }
            
            try {
                const response = await fetch('/api/reviews/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content: text })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Review submitted successfully!');
                    document.getElementById('reviewText').value = '';
                    loadReviews(); // Reload reviews
                } else {
                    alert('Failed to submit review. Please try again.');
                }
            } catch (error) {
                console.error('Error submitting review:', error);
                alert('Error submitting review. Please try again.');
            }
        }
        
        loadReviews();
    </script>
</body>
</html>

