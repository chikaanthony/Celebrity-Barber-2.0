<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book a Session - Celebrity Barber</title>

    <link rel="stylesheet" href="../static/style.css">
    <link rel="stylesheet" href="../static/bookcut.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Orbitron:wght@500;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>

    <!-- Close Button -->
    <a href="/clientdashboard" class="close-btn">
        <span>âœ•</span>
    </a>

    <!-- Booking Container -->
    <div class="booking-container">
        
        <!-- Page Header -->
        <div class="booking-header">
            <h1>Book a <span class="gold-accent">Session</span></h1>
        </div>

        <!-- Payment Details -->
        <div class="payment-details-section">
            <h2>Payment Details</h2>
            <div class="payment-card">
                <div class="payment-row">
                    <span class="payment-label">Account Number</span>
                    <div class="payment-value-wrap">
                        <span class="payment-value" id="bookcutAccountNumber">9161312015</span>
                        <button type="button" class="copy-btn" onclick="copyPaymentField('bookcutAccountNumber', 'Account number')">Copy</button>
                    </div>
                </div>
                <div class="payment-row">
                    <span class="payment-label">Bank Name</span>
                    <span class="payment-value" id="bookcutBankName">opay</span>
                </div>
                <div class="payment-row">
                    <span class="payment-label">Account Name</span>
                    <span class="payment-value" id="bookcutAccountName">chika bright anthony</span>
                </div>
                <button type="button" class="copy-all-btn" onclick="copyBookcutPaymentDetails()">Copy Full Details</button>
                <div class="copy-status" id="bookcutCopyStatus" aria-live="polite"></div>
            </div>
        </div>

        <!-- Service Selection -->
        <div class="service-section">
            <h2>Select Service</h2>
            <div class="service-grid" id="serviceGrid">
                <!-- Services loaded dynamically from API -->
            </div>
        </div>

        <!-- Date Picker -->
        <div class="date-section">
            <h2>Preferred Date</h2>
            <div class="date-input-wrapper">
                <input type="date" id="booking-date" class="date-input" required>
                <span class="calendar-icon">ðŸ“…</span>
            </div>
        </div>

        <!-- Special Requests -->
        <div class="requests-section">
            <h2>Special Requests</h2>
            <div class="textarea-wrapper">
                <textarea id="special-requests" placeholder="Any special requests..."></textarea>
                <label for="receipt-upload" class="upload-btn">
                    ðŸ“· Upload Receipt
                </label>
                <input type="file" id="receipt-upload" accept="image/*" hidden>
            </div>
        </div>

        <!-- Book Now Button -->
        <button class="book-now-btn" onclick="submitBooking()">
            BOOK NOW
        </button>

    </div>

    <!-- Success Message -->
    <div class="success-overlay" id="successOverlay">
        <div class="success-content">
            <span class="success-icon">âœ“</span>
            <h2>Booking Confirmed!</h2>
            <p>Your appointment has been submitted successfully.</p>
            <a href="/clientdashboard" class="return-btn">Return to Dashboard</a>
        </div>
    </div>

    <script>
        let selectedService = null;
        let selectedPrice = 0;

        async function copyTextToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(text);
                return;
            }

            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            document.execCommand('copy');
            textArea.remove();
        }

        function showCopyStatus(message, isError = false) {
            const status = document.getElementById('bookcutCopyStatus');
            if (!status) return;

            status.textContent = message;
            status.classList.toggle('error', isError);
        }

        async function copyPaymentField(elementId, label) {
            const field = document.getElementById(elementId);
            if (!field) return;

            try {
                await copyTextToClipboard(field.textContent.trim());
                showCopyStatus(`${label} copied.`);
            } catch (error) {
                console.error('Copy failed:', error);
                showCopyStatus(`Unable to copy ${label.toLowerCase()}.`, true);
            }
        }

        async function copyBookcutPaymentDetails() {
            const accountNumber = document.getElementById('bookcutAccountNumber')?.textContent.trim() || '';
            const bankName = document.getElementById('bookcutBankName')?.textContent.trim() || '';
            const accountName = document.getElementById('bookcutAccountName')?.textContent.trim() || '';
            const details = `Acct No: ${accountNumber}\nBank Name: ${bankName}\nAcct Name: ${accountName}`;

            try {
                await copyTextToClipboard(details);
                showCopyStatus('Full payment details copied.');
            } catch (error) {
                console.error('Copy failed:', error);
                showCopyStatus('Unable to copy payment details.', true);
            }
        }

        // Load services from API on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadServices();
        });

        async function loadServices() {
            try {
                const response = await fetch('/api/services');
                const result = await response.json();
                
                const container = document.getElementById('serviceGrid');
                
                if (result.success && result.data && result.data.length > 0) {
                    // Render services from database
                    container.innerHTML = result.data.map(service => `
                        <div class="service-card" onclick="selectService(this, '${service.name}', ${service.price})">
                            <span class="service-name">${service.name}</span>
                            <span class="service-price">â‚¦${service.price.toLocaleString()}</span>
                        </div>
                    `).join('');
                } else {
                    // No services in database yet
                    container.innerHTML = `
                        <div class="empty-state" style="grid-column: 1/-1; padding: 40px;">
                            <div class="empty-icon">ðŸ’‡</div>
                            <div>No services available</div>
                            <p style="color: #666; margin-top: 10px;">Please check back later or contact the shop</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading services:', error);
            }
        }

        function selectService(card, serviceName, price) {
            // Remove selected class from all cards
            document.querySelectorAll('.service-card').forEach(c => c.classList.remove('selected'));
            
            // Add selected class to clicked card
            card.classList.add('selected');
            
            // Store selection
            selectedService = serviceName;
            selectedPrice = price;
        }

        function submitBooking() {
            const date = document.getElementById('booking-date').value;
            const requests = document.getElementById('special-requests').value;
            const receiptFile = document.getElementById('receipt-upload').files[0];

            // Validation
            if (!selectedService) {
                alert('Please select a service!');
                return;
            }

            if (!date) {
                alert('Please select a date!');
                return;
            }

            // Convert receipt to base64
            const convertToBase64 = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            };
            
            const processBooking = async () => {
                let receiptBase64 = '';
                if (receiptFile) {
                    try {
                        receiptBase64 = await convertToBase64(receiptFile);
                    } catch (e) {
                        console.error('Error converting receipt:', e);
                    }
                }

                // Send to Firebase
                fetch('/api/book', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        service: selectedService,
                        price: selectedPrice,
                        date: date,
                        requests: requests,
                        receipt: receiptBase64
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message
                        document.getElementById('successOverlay').classList.add('active');
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error submitting booking. Please try again.');
                });
            };
            
            processBooking();
        }
    </script>
</body>
</html>
