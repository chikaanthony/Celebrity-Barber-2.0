<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Referral Hub - Celebrity Barber</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='refer.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="refer-container">
        <!-- Close Button -->
        <button class="close-btn" onclick="window.location.href='/clientdashboard'">‚úï</button>
        
        <!-- Referral Header -->
        <h1 class="referral-header">REFERRAL HUB</h1>
        <hr class="header-separator">
        
        <!-- Referral Code Display -->
        <div class="referral-code-section">
            <label class="code-label">YOUR REFERRAL CODE:</label>
            <div class="code-display" onclick="copyCode()">
                <span class="code-value" id="referralCode">3EFCVAHG</span>
                <span class="copy-icon">üìã</span>
            </div>
            <span class="copy-hint">Click to copy</span>
        </div>
        
        <!-- Progress Tracker -->
        <div class="progress-section">
            <h2 class="progress-title">PROGRESS TOWARD FREE CUT</h2>
            <div class="milestones">
                <div class="milestone" id="milestone1">
                    <div class="milestone-circle active">
                        <span class="milestone-icon">üéüÔ∏è</span>
                    </div>
                    <span class="milestone-label">30% OFF</span>
                </div>
                <div class="milestone-line"></div>
                <div class="milestone" id="milestone2">
                    <div class="milestone-circle">
                        <span class="milestone-icon">üéüÔ∏è</span>
                    </div>
                    <span class="milestone-label">60% OFF</span>
                </div>
                <div class="milestone-line"></div>
                <div class="milestone" id="milestone3">
                    <div class="milestone-circle">
                        <span class="milestone-icon">‚úÇÔ∏è</span>
                    </div>
                    <span class="milestone-label">FREE CUT</span>
                </div>
            </div>
            <p class="progress-hint" id="progressHint">Refer friends to unlock rewards!</p>
        </div>
        
        <!-- Referral Input Section -->
        <div class="refer-input-section">
            <input 
                type="text" 
                class="refer-input" 
                id="friendName"
                placeholder="Friend's Full Name..."
            >
            <button class="refer-btn" onclick="submitReferral()">REFER</button>
        </div>
        
        <!-- Referral History -->
        <div class="referral-history">
            <h3 class="history-title">REFERRAL HISTORY</h3>
            <div class="history-list" id="historyList">
                <div class="history-empty">
                    <span>No referrals yet. Start referring friends!</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Success Toast -->
    <div class="toast" id="toast">
        <span class="toast-icon">‚úì</span>
        <span class="toast-message" id="toastMessage">Referral sent successfully!</span>
    </div>
    
    <script>
        // Fetch user profile data
        let referralCount = 0;
        let userReferralCode = '';
        
        async function fetchUserData() {
            try {
                const [profileResponse, referralsResponse] = await Promise.all([
                    fetch('/api/user/profile'),
                    fetch('/api/user/referrals')
                ]);
                const profileResult = await profileResponse.json();
                const referralsResult = await referralsResponse.json();
                let profileReferralCount = 0;
                let historyReferralCount = 0;
                let referrals = [];

                if (profileResult.success) {
                    const userData = profileResult.data;
                    const rawProfileCount =
                        userData.referral_count ??
                        userData.referrals_count ??
                        userData.total_referrals ??
                        userData.referral_streak ??
                        0;
                    profileReferralCount = Number(rawProfileCount) || 0;
                    userReferralCode = userData.referral_code || '';
                    
                    // Set referral code
                    if (userReferralCode) {
                        document.getElementById('referralCode').textContent = userReferralCode;
                    }
                }

                if (referralsResult.success && Array.isArray(referralsResult.data)) {
                    referrals = referralsResult.data;
                    historyReferralCount = referrals.length;
                }

                referralCount = Math.max(profileReferralCount, historyReferralCount, 0);
                // Update progress milestones based on actual count
                updateProgressFromCount(referralCount);
                renderReferralHistory(referrals, referralCount);
            } catch (error) {
                console.error('Error fetching user data:', error);
                renderReferralHistory([], referralCount);
            }
        }
        
        // Update progress from fetched count
        function updateProgressFromCount(count) {
            const total = Math.max(0, Number(count) || 0);
            const cycleProgress = total % 3;
            const completedCycles = Math.floor(total / 3);
            const hint = document.getElementById('progressHint');

            document.getElementById('milestone1').querySelector('.milestone-circle').classList.remove('active');
            document.getElementById('milestone2').querySelector('.milestone-circle').classList.remove('active');
            document.getElementById('milestone3').querySelector('.milestone-circle').classList.remove('active');

            if (cycleProgress >= 1) {
                document.getElementById('milestone1').querySelector('.milestone-circle').classList.add('active');
            }
            if (cycleProgress >= 2) {
                document.getElementById('milestone2').querySelector('.milestone-circle').classList.add('active');
            }

            if (hint) {
                if (total > 0 && cycleProgress === 0) {
                    hint.textContent = `${completedCycles} FREE CUT reward${completedCycles > 1 ? 's' : ''} unlocked. New cycle started.`;
                } else if (cycleProgress >= 1) {
                    hint.textContent = `${3 - cycleProgress} more referral(s) to unlock FREE CUT.`;
                } else {
                    hint.textContent = 'Refer friends to unlock rewards!';
                }
            }
        }
        
        // Copy code to clipboard
        function copyCode() {
            const code = document.getElementById('referralCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showToast('Code copied to clipboard!');
            });
        }
        
        // Submit referral
        function submitReferral() {
            const friendName = document.getElementById('friendName').value.trim();
            
            if (!friendName && !userReferralCode) {
                showToast('Referral code is not ready yet. Refresh and try again.');
                return;
            }

            const code = (document.getElementById('referralCode').textContent || userReferralCode || '').trim();
            const friendPrefix = friendName ? `Hi ${friendName}, ` : 'Hi, ';
            const shareText = `${friendPrefix}use my Celebrity Barber referral code ${code} when signing up.`;

            if (navigator.share) {
                navigator.share({
                    title: 'Celebrity Barber Referral',
                    text: shareText
                }).then(() => {
                    showToast('Referral message shared.');
                }).catch(() => {
                    // Ignore cancel errors from native share sheet.
                });
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    showToast('Referral message copied. Send it to your friend.');
                }).catch(() => {
                    showToast('Copy failed. Please try again.');
                });
            }

            document.getElementById('friendName').value = '';
        }

        function renderReferralHistory(referrals, totalCount) {
            const historyList = document.getElementById('historyList');
            if (!historyList) return;

            if (Array.isArray(referrals) && referrals.length > 0) {
                const rows = referrals
                    .slice()
                    .sort((a, b) => {
                        const ta = Date.parse(a.referred_at || '') || 0;
                        const tb = Date.parse(b.referred_at || '') || 0;
                        return tb - ta;
                    })
                    .map((ref) => {
                        const statusRaw = String(ref.status || 'pending').toLowerCase();
                        const statusClass = statusRaw === 'successful' ? 'completed' : 'pending';
                        const statusLabel = statusRaw === 'successful' ? 'Successful' : 'Pending';
                        const name = escapeHtml(ref.name || ref.email || 'Referral');
                        return `
                            <div class="history-item">
                                <span class="history-name">${name}</span>
                                <span class="history-status ${statusClass}">${statusLabel}</span>
                            </div>
                        `;
                    })
                    .join('');
                historyList.innerHTML = rows;
                return;
            }

            if ((Number(totalCount) || 0) > 0) {
                historyList.innerHTML = `
                    <div class="history-item">
                        <span class="history-name">${Number(totalCount)} referral(s) credited</span>
                        <span class="history-status completed">Recorded</span>
                    </div>
                `;
                return;
            }

            historyList.innerHTML = `
                <div class="history-empty">
                    <span>No referrals yet. Share your code to start earning rewards.</span>
                </div>
            `;
        }

        function escapeHtml(value) {
            return String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }
        
        // Show toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Initialize
        fetchUserData();
    </script>
</body>
</html>
